
Servicio: Post
##############

Este servicio se encargará de efectuar las peticiones a la Rest API
relacionadas con las publicaciones del blog

-  Se realiza la creación del servicio para la Rest Api de WordPress con
   el siguiente comando:

``ng generate service services/blog``

-  Se procede a efectuar la importación de las diferentes dependencias y
   tipos requeridos en el servicio tal como se aprecia a continuación.
   Así mismo, se define las variables y endpoints de la API previamente
   definidos en el environment.

.. code:: typescript

   import { Injectable } from '@angular/core';
   import {HttpClient, HttpErrorResponse, HttpHeaders} from '@angular/common/http';
   import { Observable, of, throwError } from 'rxjs';
   import { catchError, map} from 'rxjs/operators';
   import { Wp_Category } from '../../interfaces/WP_Category';
   import { Post} from 'src/app/interfaces/post';

   @Injectable({
     providedIn: 'root',
   })

   export class BlogService {
   // Endpoint de WordPress Rest API
     WP_API: string = environment.WP_REST.API;
   //Parametros para la consulta de los posts
     allPosts = null;
     pages: any;

     constructor(private http: HttpClient) { }

   } 

Procedimiento: Error de respuesta
*********************************

-  Este procedimiento es el encargado de gestionar las respuestas de
   error obtenidas de la API, este recibe como parametro el error de la
   depedencia HttpErrorResponse

.. code:: typescript

   handleError(error: HttpErrorResponse) {
       let errorMessage = 'Hubo un problema, intente nuevamente';
       if (error.error instanceof ErrorEvent) {
         // Errores del lado del cliente
         errorMessage = `Error: ${error.error.message}`;
       } else {
         // Errores del lado de la api
         errorMessage = `Código de error: ${error.status}\n Mensaje: ${error.message}`;
       }
       return throwError(errorMessage);
     }

Método: Listar publicaciones
****************************

-  Se define este método que será el encargado de traer todas las
   publicaciones del blog de acuerdo al parámetro de número de
   publicaciones por página, el número de página y ordenando los post
   por su modificación.

.. code:: typescript

   getRecentPosts(page = 1): Observable<Post[]> {
       let options = {
         observe: 'response' as 'body',
         params: {
           per_page: '10',
           page: '' + page,
           orderby: 'modified',
         },
       };

       return this.http
         .get<any[]>(`${this.WP_API}posts?_embed=true`, options)
         .pipe(
           map((res) => {
             this.pages = res['headers'].get('x-wp-totalpages');
             this.allPosts = res['headers'].get('x-wp-total');
             return res['body'];
           }),
           catchError(this.handleError)
         );

Método: Detalles publicación
****************************

-  Este método se encargará de traer la información detallada de una
   publicación especifica, para ello recibe como parámetro el id del
   post para realizar la correspondiente llamada al punto final.

.. code:: typescript

   getPost(id: any) : Observable<Post> {
       return this.http.get<Post>(`${this.WP_API}posts/${id}?_embed`).pipe(
         map((post) => {
           return post;
         })
       );
     }

Método: Crear nueva publicación
*******************************

-  Se define este método para la creación de nuevas publicaciones, este
   recibe como parametro un array con la información requerida para la
   creación de un nuevo post. Adicionalmente se define un encabezado en
   el que se agregará los detalles de autenticación requeridos para
   efectuar exitosamente la petición.

.. code:: typescript

    createpost(data: any): Observable<Post[]> {
       let options = {
         headers: {
           Authorization: 'Bearer ' + localStorage.getItem('wp-token'),
         },
       };
       return this.http
         .post<Post[]>(`${this.WP_API}posts`, data, options)
         .pipe(catchError(this.handleError));
     }

Método: Modificar publicación
*****************************

-  Este método es el encargado de modificar las publicaciones del blog,
   este recibe como parametro el id del post y un array (data) con la
   información requerida para la modificación del mismo. Adicionalmente
   se define un encabezado en el que se agregará los detalles de
   autenticación requeridos para efectuar exitosamente la petición.

.. code:: typescript

    updatepost(id: any, data: any): Observable<Post> {
       let options = {
         headers: {
           Authorization: 'Bearer ' + localStorage.getItem('wp-token'),
         },
       };
       return this.http
         .post<Post>(`${this.WP_API}posts/${id}`, data, options)
         .pipe(catchError(this.handleError));
     }

Método: Eliminar publicación
****************************

-  Este se encarga de efectuar la eliminación de una publiación, este
   recibe como parametro el id del post y un array (data) con la
   información requerida para la modificación del mismo. Adicionalmente
   se define un encabezado en el que se agregará los detalles de
   autenticación requeridos para efectuar exitosamente la petición.

.. code:: typescript

    deletepost(id: any): Observable<any> {
       let options = {
         headers: {
           Authorization: 'Bearer ' + localStorage.getItem('wp-token'),
         },
       };
       return this.http
         .delete(`${this.WP_API}posts/${id}`, options)
         .pipe(catchError(this.handleError));
     }

Método: Listar Categorias
*************************

-  Se define el método que se encarga de obtener el listado de todas las
   categorias existentes en el blog.
-  

.. code:: typescript

   getCategories() {
       return this.http.get(`${this.WP_API}categories`);
     }

Al añadir cada uno de los métodos mencionados y el procedimiento
encargado de manipular los errores de la API el código del servicio
tendrá el siguiente aspecto:

Código Fuente completo del Servicio: Post
*****************************************

.. code:: typescript

   import { environment } from 'src/environments/environment';
   import {HttpClient, HttpErrorResponse, HttpHeaders} from '@angular/common/http';
   import { Injectable } from '@angular/core';
   import { Observable, of, throwError } from 'rxjs';
   import { catchError, map} from 'rxjs/operators';
   import { WP_User } from '../../interfaces/WP_User';
   import { Wp_Category } from '../../interfaces/WP_Category';
   import { Post} from 'src/app/interfaces/post';

   @Injectable({
     providedIn: 'root',
   })
   export class BlogService {
     // URL del blog que vamos a trabajar con su REST API
     WP_API: string = environment.WP_REST.API;
     //Opciones de blog
     allPosts = null;
     pages: any;

     constructor(private http: HttpClient) {}

      /**
      * procedimiento encargado de administrar las respuestas de error de wp-rest-api
      * @params error - Respuesta de error obtenida de la petición mediante dependecia HTTP
      * @returns Mensaje de error obtenido
      */

     handleError(error: HttpErrorResponse) {
       let errorMessage = 'Hubo un problema, intente nuevamente';
       if (error.error instanceof ErrorEvent) {
         // Errores del lado del cliente
         errorMessage = `Error: ${error.error.message}`;
       } else {
         // Errores del lado de la api
         errorMessage = `Código de error: ${error.status}\n Mensaje: ${error.message}`;
       }
       return throwError(errorMessage);
     }

     /**
      * Método encargado de obtener el listado de los posts publicados en el blog
      * @params page - Número de la página a consultar
      * @returns Respuesta de petición de la api
      */
     getRecentPosts(page = 1): Observable<Post[]> {
       let options = {
         observe: 'response' as 'body',
         params: {
           per_page: '10',
           page: '' + page,
           orderby: 'modified',
         },
       };

       return this.http
         .get<Post[]>(`${this.WP_API}posts?_embed=true`, options)
         .pipe(
           map((res) => {
             this.pages = res['headers'].get('x-wp-totalpages');
             this.allPosts = res['headers'].get('x-wp-total');
             return res['body'];
           }),
           catchError(this.handleError)
         );
     }

     /**
      * Método encargado de obtener detalles de un post especifico
      * @params id - ID del post a consultar
      * @returns Respuesta de petición de la api
      */
     getPost(id: any) : Observable<Post> {
       return this.http.get<Post>(`${this.WP_API}posts/${id}?_embed`).pipe(
         map((post) => {
           return post;
         })
       );
     }

     getCategories() {
       return this.http.get(`${this.WP_API}categories`);
     }


     /**
      * Método encargado de crear un nuevo post
      * @params data - Array con la información ingresada por el usuario en el modal 
      * @returns Respuesta de petición de la api
      */
     createpost(data: any): Observable<Post[]> {
       let options = {
         headers: {
           Authorization: 'Bearer ' + localStorage.getItem('wp-token'),
         },
       };
       return this.http
         .post<Post[]>(`${this.WP_API}posts`, data, options)
         .pipe(catchError(this.handleError));
     }


     /**
      * Método encargado de actualizar un post
      * @params id - Número de identificación del posts
      * @params data - Array con los datos a modificar del post existente
      * @returns Respuesta de petición de la api
      */

     updatepost(id: any, data: any): Observable<Post> {
       let options = {
         headers: {
           Authorization: 'Bearer ' + localStorage.getItem('wp-token'),
         },
       };
       return this.http
         .post<Post>(`${this.WP_API}posts/${id}`, data, options)
         .pipe(catchError(this.handleError));
     }

     /**
      * Método encargado de eliminar un post
      * @params Id - Número de identificación del post a eliminar
      * @returns Respuesta de petición de la api
      */

     deletepost(id: any): Observable<any> {
       let options = {
         headers: {
           Authorization: 'Bearer ' + localStorage.getItem('wp-token'),
         },
       };
       return this.http
         .delete(`${this.WP_API}posts/${id}`, options)
         .pipe(catchError(this.handleError));
     }
